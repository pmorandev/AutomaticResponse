from automated.service.ImapServiceImpl import ImapServiceImpl
from unittest import TestCase, mock
import imaplib

class testImapService(TestCase):

    def test_badCredentials(self):
        with self.assertRaises(imaplib.IMAP4.error) as context:
            ImapServiceImpl(('imap.gmail.com','bademail@gmail.com','badpassword'))

    def test_getNewEmailsFound(self):
        imapServer = mock.create_autospec(imaplib.IMAP4_SSL)
        imapServer.search.return_value = ('OK', [b'11202 11205'])
        imapServer.fetch.return_value = ('OK', [(b'11205 (RFC822 {13538}', b'Delivered-To: p.morandev@gmail.com\r\nReceived: by 2002:a05:6512:1512:0:0:0:0 with SMTP id bq18csp4363526lfb;\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nX-Google-Smtp-Source: ABdhPJxCrcGYJtqnFuwDMGtCJ7JySAhIqxW+hng/G26sAasaCXrtosYafKUW1G629+X8Tg3QHSaM\r\nX-Received: by 2002:ae9:e810:: with SMTP id a16mr1778804qkg.492.1631570345492;\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nARC-Seal: i=1; a=rsa-sha256; t=1631570345; cv=none;\r\n        d=google.com; s=arc-20160816;\r\n        b=sAyFpZJAB1JL4VVbQe6CiKLUB8M8NMeCXFjvMI+9+FyEEv/WaULqr60zzVrgrx+apF\r\n         VeJa4wfJctqbVvCW9EhCH3mewg23PwFcrl9SdZaxp2uXgewh+ry9IYrJVyI0gRhr9VNW\r\n         R4G8ooskd28Gd+n4ID9FURRt7b1pHT1zdeiaztia3QirNQLSsXzfbWv6kQgAUKjqBrEl\r\n         dQBBxGKi1Fwthc457apO2mTBRehH6q4Svqb9A8z/80scT5O52AFB6UKPWgz24xs67BIe\r\n         yjGk61g7+EUQgOEcFKbLem8JXIWGioCNnawlLwV5x5uw0M440KiKx8MbUdRdZ1bU/Bfu\r\n         gs6A==\r\nARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;\r\n        h=mime-version:subject:message-id:to:from:date:domainkey-signature\r\n         :dkim-signature;\r\n        bh=yyUmc2RikGRcbuw8fKelWi4t8vPmLu/RriUWtQNOvuY=;\r\n        b=g1jFh8U69g/WfY3OYVQPQ9d47CMXP7w0pg4ANkahgHdbz9VrSPaOB4FwRvWO7Sa/KW\r\n         LvEuySDMmFUGIhSMdM8sNM2VkgCjCk2vPF34BUM5cU1vSsxoIjsUUw92vGV1iuxz2UIE\r\n         jFqTzIBZMN0O3aMKQDjByodfczMk9w6zYmIi+EZv8dTbsOaViaG6SN9t8YQzTasBd+Un\r\n         oQ1wZ7iEdBblExekAzI4PZFJ4zGGfCWuiMp02j5ZB3f1SFIfuApluMEv7laNOKcDUoXp\r\n         SgdSpetNqNV4OkTEiObbhAREUGz8szpRCdxoi4ffn5D/IS6TZuZlOFbNP/DAYaAneqGk\r\n         toGA==\r\nARC-Authentication-Results: i=1; mx.google.com;\r\n       dkim=pass header.i=@jobopportunityforyou.com header.s=key8 header.b=dSGN0vnq;\r\n       spf=pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) smtp.mailfrom=navya.thoutreddy@axelon.com;\r\n       dmarc=pass (p=QUARANTINE sp=QUARANTINE dis=NONE) header.from=axelon.com\r\nReturn-Path: <navya.thoutreddy@axelon.com>\r\nReceived: from mail.jobopportunityforyou.com (mail.jobopportunityforyou.com. [209.160.136.75])\r\n        by mx.google.com with ESMTPS id l21si4975082qkj.141.2021.09.13.14.59.05\r\n        for <p.morandev@gmail.com>\r\n        (version=TLS1_2 cipher=ECDHE-ECDSA-AES128-GCM-SHA256 bits=128/128);\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nReceived-SPF: pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) client-ip=209.160.136.75;\r\nAuthentication-Results: mx.google.com;\r\n       dkim=pass header.i=@jobopportunityforyou.com header.s=key8 header.b=dSGN0vnq;\r\n       spf=pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) smtp.mailfrom=navya.thoutreddy@axelon.com;\r\n       dmarc=pass (p=QUARANTINE sp=QUARANTINE dis=NONE) header.from=axelon.com\r\nDKIM-Signature: v=1; a=rsa-sha1; c=relaxed/relaxed; s=key8; d=jobopportunityforyou.com;\r\n h=Date:From:To:Message-ID:Subject:MIME-Version:Content-Type;\r\n bh=XXwqn5gtrm9Qq764ke0jI8Neslk=;\r\n b=dSGN0vnqDUNJalMA89ONiN806AMOiDC4YAxLccgHd5pt7NoDEY5agXp9IarU/qk9Ll9jsqTPRQPD\r\n   mIcCcP+1SyI7XxIomHYIeW9eyceEKofXMR55WmJnIGNlpsxae0RFSRV0Y7mhas96R7EWJ5iRBegj\r\n   7PCvk5TzNjgAW8aav3Q=\r\nDomainKey-Signature: a=rsa-sha1; c=nofws; q=dns; s=jd1; d=axelon.com;\r\n b=FRWdQCTpwklOUpeIhaMxsGTP1akbams1Q6qd8Cf907ewJvNFeUOj5A5CIAJO+eng1IpruxEv3J8E\r\n   YXku/Clcfhpps355K65t5w+rAAxLHk13Bun4tHuJAJ/XvAk/+12TgK71pBeH7wE31hKmPfYY+2Sz\r\n   6f32jPmPiBZur8qtqhgKgAcR4DGkprsI4MU1UqZZcaGHn/q1vkBajJocodCBQ4fkk5az34MlKnpy\r\n   oIoVsLft2oxpBgbfIjCajJ69nNFL+T7cDnFQ28jQzbRnLecL4gBuhWQGFEK/vkC6vLZ4NZhxLsUM\r\n   Ukbxvogr2DNKhwd5RbNigM2aOcOz52OGIfEGjA==;\r\nReceived: by jobopportunityforyou.com id h7v4qi1ph64e for <p.morandev@gmail.com>; Mon, 13 Sep 2021 17:57:11 -0400 (envelope-from <navya.thoutreddy@axelon.com>)\r\nDate: Mon, 13 Sep 2021 18:08:25 -0400 (EDT)\r\nFrom: Navya Thoutreddy <navya.thoutreddy@axelon.com>\r\nTo: p.morandev@gmail.com\r\nMessage-ID: <568243772.91232.1631570905308@emailmerge24.jobdiva.com>\r\nSubject: Immediate need for Java Developer, Location: Tampa, FL --- No 3rd\r\n parties PLEASE\r\nMIME-Version: 1.0\r\nContent-Type: multipart/mixed; \r\n\tboundary="----=_Part_91230_1203237364.1631570905308"\r\n\r\n------=_Part_91230_1203237364.1631570905308\r\nContent-Type: text/html; charset=utf-8\r\nContent-Transfer-Encoding: 7bit\r\n\r\n<span style="color:rgb(34, 34, 34); font-family:arial,sans-serif; font-size:9pt">09/13/21 5:55 PM</span><br />\r\n<br />\r\n<span style="color:rgb(34, 34, 34); font-family:arial,sans-serif; font-size:9pt">THIS IS A TEST EXAMPLE</span>\r\n------=_Part_91230_1203237364.1631570905308--\r\n')])
        imapService = ImapServiceImpl((), imapServer)
        newEmails = imapService.getNewEmails()
        self.assertEquals(len(newEmails), 2)

    def test_getNewEmailsNotFound(self):
        imapServer = mock.create_autospec(imaplib.IMAP4_SSL)
        imapServer.search.return_value = ('OK', [b''])
        imapService = ImapServiceImpl((), imapServer)
        newEmails = imapService.getNewEmails()
        self.assertEquals(len(newEmails), 0)

    def test_getNewEmailBodyHTML(self):
        imapServer = mock.create_autospec(imaplib.IMAP4_SSL)
        imapServer.search.return_value = ('OK', [b'11202'])
        imapServer.fetch.return_value = ('OK', [(b'11205 (RFC822 {13538}', b'Delivered-To: p.morandev@gmail.com\r\nReceived: by 2002:a05:6512:1512:0:0:0:0 with SMTP id bq18csp4363526lfb;\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nX-Google-Smtp-Source: ABdhPJxCrcGYJtqnFuwDMGtCJ7JySAhIqxW+hng/G26sAasaCXrtosYafKUW1G629+X8Tg3QHSaM\r\nX-Received: by 2002:ae9:e810:: with SMTP id a16mr1778804qkg.492.1631570345492;\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nARC-Seal: i=1; a=rsa-sha256; t=1631570345; cv=none;\r\n        d=google.com; s=arc-20160816;\r\n        b=sAyFpZJAB1JL4VVbQe6CiKLUB8M8NMeCXFjvMI+9+FyEEv/WaULqr60zzVrgrx+apF\r\n         VeJa4wfJctqbVvCW9EhCH3mewg23PwFcrl9SdZaxp2uXgewh+ry9IYrJVyI0gRhr9VNW\r\n         R4G8ooskd28Gd+n4ID9FURRt7b1pHT1zdeiaztia3QirNQLSsXzfbWv6kQgAUKjqBrEl\r\n         dQBBxGKi1Fwthc457apO2mTBRehH6q4Svqb9A8z/80scT5O52AFB6UKPWgz24xs67BIe\r\n         yjGk61g7+EUQgOEcFKbLem8JXIWGioCNnawlLwV5x5uw0M440KiKx8MbUdRdZ1bU/Bfu\r\n         gs6A==\r\nARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;\r\n        h=mime-version:subject:message-id:to:from:date:domainkey-signature\r\n         :dkim-signature;\r\n        bh=yyUmc2RikGRcbuw8fKelWi4t8vPmLu/RriUWtQNOvuY=;\r\n        b=g1jFh8U69g/WfY3OYVQPQ9d47CMXP7w0pg4ANkahgHdbz9VrSPaOB4FwRvWO7Sa/KW\r\n         LvEuySDMmFUGIhSMdM8sNM2VkgCjCk2vPF34BUM5cU1vSsxoIjsUUw92vGV1iuxz2UIE\r\n         jFqTzIBZMN0O3aMKQDjByodfczMk9w6zYmIi+EZv8dTbsOaViaG6SN9t8YQzTasBd+Un\r\n         oQ1wZ7iEdBblExekAzI4PZFJ4zGGfCWuiMp02j5ZB3f1SFIfuApluMEv7laNOKcDUoXp\r\n         SgdSpetNqNV4OkTEiObbhAREUGz8szpRCdxoi4ffn5D/IS6TZuZlOFbNP/DAYaAneqGk\r\n         toGA==\r\nARC-Authentication-Results: i=1; mx.google.com;\r\n       dkim=pass header.i=@jobopportunityforyou.com header.s=key8 header.b=dSGN0vnq;\r\n       spf=pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) smtp.mailfrom=navya.thoutreddy@axelon.com;\r\n       dmarc=pass (p=QUARANTINE sp=QUARANTINE dis=NONE) header.from=axelon.com\r\nReturn-Path: <navya.thoutreddy@axelon.com>\r\nReceived: from mail.jobopportunityforyou.com (mail.jobopportunityforyou.com. [209.160.136.75])\r\n        by mx.google.com with ESMTPS id l21si4975082qkj.141.2021.09.13.14.59.05\r\n        for <p.morandev@gmail.com>\r\n        (version=TLS1_2 cipher=ECDHE-ECDSA-AES128-GCM-SHA256 bits=128/128);\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nReceived-SPF: pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) client-ip=209.160.136.75;\r\nAuthentication-Results: mx.google.com;\r\n       dkim=pass header.i=@jobopportunityforyou.com header.s=key8 header.b=dSGN0vnq;\r\n       spf=pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) smtp.mailfrom=navya.thoutreddy@axelon.com;\r\n       dmarc=pass (p=QUARANTINE sp=QUARANTINE dis=NONE) header.from=axelon.com\r\nDKIM-Signature: v=1; a=rsa-sha1; c=relaxed/relaxed; s=key8; d=jobopportunityforyou.com;\r\n h=Date:From:To:Message-ID:Subject:MIME-Version:Content-Type;\r\n bh=XXwqn5gtrm9Qq764ke0jI8Neslk=;\r\n b=dSGN0vnqDUNJalMA89ONiN806AMOiDC4YAxLccgHd5pt7NoDEY5agXp9IarU/qk9Ll9jsqTPRQPD\r\n   mIcCcP+1SyI7XxIomHYIeW9eyceEKofXMR55WmJnIGNlpsxae0RFSRV0Y7mhas96R7EWJ5iRBegj\r\n   7PCvk5TzNjgAW8aav3Q=\r\nDomainKey-Signature: a=rsa-sha1; c=nofws; q=dns; s=jd1; d=axelon.com;\r\n b=FRWdQCTpwklOUpeIhaMxsGTP1akbams1Q6qd8Cf907ewJvNFeUOj5A5CIAJO+eng1IpruxEv3J8E\r\n   YXku/Clcfhpps355K65t5w+rAAxLHk13Bun4tHuJAJ/XvAk/+12TgK71pBeH7wE31hKmPfYY+2Sz\r\n   6f32jPmPiBZur8qtqhgKgAcR4DGkprsI4MU1UqZZcaGHn/q1vkBajJocodCBQ4fkk5az34MlKnpy\r\n   oIoVsLft2oxpBgbfIjCajJ69nNFL+T7cDnFQ28jQzbRnLecL4gBuhWQGFEK/vkC6vLZ4NZhxLsUM\r\n   Ukbxvogr2DNKhwd5RbNigM2aOcOz52OGIfEGjA==;\r\nReceived: by jobopportunityforyou.com id h7v4qi1ph64e for <p.morandev@gmail.com>; Mon, 13 Sep 2021 17:57:11 -0400 (envelope-from <navya.thoutreddy@axelon.com>)\r\nDate: Mon, 13 Sep 2021 18:08:25 -0400 (EDT)\r\nFrom: Navya Thoutreddy <navya.thoutreddy@axelon.com>\r\nTo: p.morandev@gmail.com\r\nMessage-ID: <568243772.91232.1631570905308@emailmerge24.jobdiva.com>\r\nSubject: Immediate need for Java Developer, Location: Tampa, FL --- No 3rd\r\n parties PLEASE\r\nMIME-Version: 1.0\r\nContent-Type: multipart/mixed; \r\n\tboundary="----=_Part_91230_1203237364.1631570905308"\r\n\r\n------=_Part_91230_1203237364.1631570905308\r\nContent-Type: text/html; charset=utf-8\r\nContent-Transfer-Encoding: 7bit\r\n\r\n<span style="color:rgb(34, 34, 34); font-family:arial,sans-serif; font-size:9pt">THIS IS A TEST EXAMPLE</span>\r\n------=_Part_91230_1203237364.1631570905308--\r\n')])
        imapService = ImapServiceImpl((), imapServer)
        newEmails = imapService.getNewEmails()
        self.assertEquals(newEmails[0].body, 'THIS IS A TEST EXAMPLE')

    def test_getNewEmailBodyTextPlain(self):
        imapServer = mock.create_autospec(imaplib.IMAP4_SSL)
        imapServer.search.return_value = ('OK', [b'11202'])
        imapServer.fetch.return_value = ('OK', [(b'11205 (RFC822 {13538}', b'Delivered-To: p.morandev@gmail.com\r\nReceived: by 2002:a05:6512:1512:0:0:0:0 with SMTP id bq18csp4363526lfb;\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nX-Google-Smtp-Source: ABdhPJxCrcGYJtqnFuwDMGtCJ7JySAhIqxW+hng/G26sAasaCXrtosYafKUW1G629+X8Tg3QHSaM\r\nX-Received: by 2002:ae9:e810:: with SMTP id a16mr1778804qkg.492.1631570345492;\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nARC-Seal: i=1; a=rsa-sha256; t=1631570345; cv=none;\r\n        d=google.com; s=arc-20160816;\r\n        b=sAyFpZJAB1JL4VVbQe6CiKLUB8M8NMeCXFjvMI+9+FyEEv/WaULqr60zzVrgrx+apF\r\n         VeJa4wfJctqbVvCW9EhCH3mewg23PwFcrl9SdZaxp2uXgewh+ry9IYrJVyI0gRhr9VNW\r\n         R4G8ooskd28Gd+n4ID9FURRt7b1pHT1zdeiaztia3QirNQLSsXzfbWv6kQgAUKjqBrEl\r\n         dQBBxGKi1Fwthc457apO2mTBRehH6q4Svqb9A8z/80scT5O52AFB6UKPWgz24xs67BIe\r\n         yjGk61g7+EUQgOEcFKbLem8JXIWGioCNnawlLwV5x5uw0M440KiKx8MbUdRdZ1bU/Bfu\r\n         gs6A==\r\nARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;\r\n        h=mime-version:subject:message-id:to:from:date:domainkey-signature\r\n         :dkim-signature;\r\n        bh=yyUmc2RikGRcbuw8fKelWi4t8vPmLu/RriUWtQNOvuY=;\r\n        b=g1jFh8U69g/WfY3OYVQPQ9d47CMXP7w0pg4ANkahgHdbz9VrSPaOB4FwRvWO7Sa/KW\r\n         LvEuySDMmFUGIhSMdM8sNM2VkgCjCk2vPF34BUM5cU1vSsxoIjsUUw92vGV1iuxz2UIE\r\n         jFqTzIBZMN0O3aMKQDjByodfczMk9w6zYmIi+EZv8dTbsOaViaG6SN9t8YQzTasBd+Un\r\n         oQ1wZ7iEdBblExekAzI4PZFJ4zGGfCWuiMp02j5ZB3f1SFIfuApluMEv7laNOKcDUoXp\r\n         SgdSpetNqNV4OkTEiObbhAREUGz8szpRCdxoi4ffn5D/IS6TZuZlOFbNP/DAYaAneqGk\r\n         toGA==\r\nARC-Authentication-Results: i=1; mx.google.com;\r\n       dkim=pass header.i=@jobopportunityforyou.com header.s=key8 header.b=dSGN0vnq;\r\n       spf=pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) smtp.mailfrom=navya.thoutreddy@axelon.com;\r\n       dmarc=pass (p=QUARANTINE sp=QUARANTINE dis=NONE) header.from=axelon.com\r\nReturn-Path: <navya.thoutreddy@axelon.com>\r\nReceived: from mail.jobopportunityforyou.com (mail.jobopportunityforyou.com. [209.160.136.75])\r\n        by mx.google.com with ESMTPS id l21si4975082qkj.141.2021.09.13.14.59.05\r\n        for <p.morandev@gmail.com>\r\n        (version=TLS1_2 cipher=ECDHE-ECDSA-AES128-GCM-SHA256 bits=128/128);\r\n        Mon, 13 Sep 2021 14:59:05 -0700 (PDT)\r\nReceived-SPF: pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) client-ip=209.160.136.75;\r\nAuthentication-Results: mx.google.com;\r\n       dkim=pass header.i=@jobopportunityforyou.com header.s=key8 header.b=dSGN0vnq;\r\n       spf=pass (google.com: domain of navya.thoutreddy@axelon.com designates 209.160.136.75 as permitted sender) smtp.mailfrom=navya.thoutreddy@axelon.com;\r\n       dmarc=pass (p=QUARANTINE sp=QUARANTINE dis=NONE) header.from=axelon.com\r\nDKIM-Signature: v=1; a=rsa-sha1; c=relaxed/relaxed; s=key8; d=jobopportunityforyou.com;\r\n h=Date:From:To:Message-ID:Subject:MIME-Version:Content-Type;\r\n bh=XXwqn5gtrm9Qq764ke0jI8Neslk=;\r\n b=dSGN0vnqDUNJalMA89ONiN806AMOiDC4YAxLccgHd5pt7NoDEY5agXp9IarU/qk9Ll9jsqTPRQPD\r\n   mIcCcP+1SyI7XxIomHYIeW9eyceEKofXMR55WmJnIGNlpsxae0RFSRV0Y7mhas96R7EWJ5iRBegj\r\n   7PCvk5TzNjgAW8aav3Q=\r\nDomainKey-Signature: a=rsa-sha1; c=nofws; q=dns; s=jd1; d=axelon.com;\r\n b=FRWdQCTpwklOUpeIhaMxsGTP1akbams1Q6qd8Cf907ewJvNFeUOj5A5CIAJO+eng1IpruxEv3J8E\r\n   YXku/Clcfhpps355K65t5w+rAAxLHk13Bun4tHuJAJ/XvAk/+12TgK71pBeH7wE31hKmPfYY+2Sz\r\n   6f32jPmPiBZur8qtqhgKgAcR4DGkprsI4MU1UqZZcaGHn/q1vkBajJocodCBQ4fkk5az34MlKnpy\r\n   oIoVsLft2oxpBgbfIjCajJ69nNFL+T7cDnFQ28jQzbRnLecL4gBuhWQGFEK/vkC6vLZ4NZhxLsUM\r\n   Ukbxvogr2DNKhwd5RbNigM2aOcOz52OGIfEGjA==;\r\nReceived: by jobopportunityforyou.com id h7v4qi1ph64e for <p.morandev@gmail.com>; Mon, 13 Sep 2021 17:57:11 -0400 (envelope-from <navya.thoutreddy@axelon.com>)\r\nDate: Mon, 13 Sep 2021 18:08:25 -0400 (EDT)\r\nFrom: Navya Thoutreddy <navya.thoutreddy@axelon.com>\r\nTo: p.morandev@gmail.com\r\nMessage-ID: <568243772.91232.1631570905308@emailmerge24.jobdiva.com>\r\nSubject: Immediate need for Java Developer, Location: Tampa, FL --- No 3rd\r\n parties PLEASE\r\nMIME-Version: 1.0\r\nContent-Type: multipart/mixed; \r\n\tboundary="----=_Part_91230_1203237364.1631570905308"\r\n\r\n------=_Part_91230_1203237364.1631570905308\r\nContent-Type: text/plain; charset=utf-8\r\nContent-Transfer-Encoding: 7bit\r\n\r\nTHIS IS A TEST EXAMPLE\r\n------=_Part_91230_1203237364.1631570905308--\r\n')])
        imapService = ImapServiceImpl((), imapServer)
        newEmails = imapService.getNewEmails()
        self.assertEquals(newEmails[0].body, 'THIS IS A TEST EXAMPLE')